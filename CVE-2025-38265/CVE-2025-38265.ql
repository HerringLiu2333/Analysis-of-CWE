import cpp

// 从 Function(函数) 和 FieldAccess(字段访问) 中查询
from Function f, FieldAccess devAccess
where
  // 1. 首先，将我们的搜索范围锚定在名为 'jsm_uart_port_init' 的函数中。
  f.hasName("jsm_uart_port_init") and
  devAccess.getEnclosingFunction() = f and

  // 2. 我们从最外层的访问开始：查找所有对名为 'dev' 字段的访问。
  devAccess.getTarget().getName() = "dev" and

  // 3. 向上追溯一级：检查 'dev' 字段是否在一个名为 'uart_port' 的结构体上被访问。
  //    devAccess.getQualifier() 返回 '...->uart_port' 这个表达式。
  exists(FieldAccess uartPortAccess |
    uartPortAccess = devAccess.getQualifier() and
    uartPortAccess.getTarget().getName() = "uart_port" and

    // 4. 再向上一级：检查 'uart_port' 是否在一个数组元素上被访问。
    //    uartPortAccess.getQualifier() 返回 '...[...]' 这个表达式。
    exists(ArrayExpr channelArrayAccess |
      channelArrayAccess = uartPortAccess.getQualifier() and

      // 5. 最后，检查这个数组本身是否是名为 'channels' 的字段。
      //    channelArrayAccess.getArrayBase() 返回 '...->channels' 这个表达式。
      exists(FieldAccess channelsAccess |
        channelsAccess = channelArrayAccess.getArrayBase() and
        channelsAccess.getTarget().getName() = "channels"

        // 6. (可选但推荐) 确认 'channels' 字段是在名为 'brd' 的变量上被访问。
        // channelsAccess.getQualifier().(VariableAccess).getTarget().getName() = "brd"
      )
    )
  )

// 如果找到了完全匹配上述结构的代码，就把它选择出来。
select devAccess