/**
 * @name CVE-2024-58059
 * @description In uvcvideo, uvc_probe() failure could call uvc_status_unregister()
 *  before uvc_status_init() ran, leading to unregistering an uninitialized
 *  status path and potential deadlock or NULL dereference. The fix skips
 *  unregister when dev->status is NULL.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/unregister-before-init-null-check
 * @tags 
 *  correctness
 *  reliability
 *  null-dereference
 *  deadlock
 *  usb
 *  media
 * @patch-commit db577ededf3a18b39567fc1a6209f12a0c4a3c52
 * @source-file drivers/media/usb/uvc/uvc_status.c
 * @affected-function uvc_status_unregister
 * @vulnerability-type unregister-before-initialization
 * @patch-diff |
 *  diff --git a/drivers/media/usb/uvc/uvc_status.c b/drivers/media/usb/uvc/uvc_status.c
 *  index 06c867510c8fe6…f37417634ee944 100644
 *  -- a/drivers/media/usb/uvc/uvc_status.c
 *  +++ b/drivers/media/usb/uvc/uvc_status.c
 *  @@ -294,6 +294,9 @@ int uvc_status_init(struct uvc_device *dev)
 *
 *    void uvc_status_unregister(struct uvc_device *dev)
 *    {
 *  + if (!dev->status)
 *  + return;
 *  +
 *    uvc_status_suspend(dev);
 *    uvc_input_unregister(dev);
 *    }
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db577ededf3a18b39567fc1a6209f12a0c4a3c52
 * @remediation Guard unregister paths with a NULL check on dev->status (or equivalent state)
 *  to ensure resources are only torn down if they were initialized. In probe error
 *  paths, unwind in the reverse order of successful initialization and skip steps
 *  that were not reached.
 */



import cpp

/*
 * 检测UVC视频驱动中的死锁和NULL指针解引用漏洞
 * 该查询用于识别在uvc_status_unregister函数中访问dev->status之前未进行NULL检查的情况
 * 这可能导致在status未初始化时出现NULL指针解引用错误
 * This query identifies NULL pointer dereference vulnerabilities where
 * dev->status is accessed without NULL check in uvc_status_unregister function
 */


from
  Function uvc_status_unregister, FunctionCall uvc_status_suspend
  
where
  // 限制在uvc_status_unregister函数内
  uvc_status_unregister.getName() = "uvc_status_unregister" and
  uvc_status_suspend.getTarget().getName() = "uvc_status_suspend" and
  uvc_status_suspend.getEnclosingFunction() = uvc_status_unregister and
  // 查找dev->status访问
  uvc_status_suspend.getArgument(0).toString().matches("%dev%") and
  // 在访问之前没有NULL检查
  not exists(IfStmt ifstmt |
    ifstmt.getEnclosingFunction() = uvc_status_unregister and
    ifstmt.getASuccessor().toString().matches("%dev%") and
    ifstmt.getLocation().getStartLine() < uvc_status_suspend.getLocation().getStartLine()
  )
select
  uvc_status_suspend,
  "Potential NULL pointer dereference: dev->status accessed without NULL check in uvc_status_unregister()"