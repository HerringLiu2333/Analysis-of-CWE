import cpp
import semmle.code.cpp.controlflow.Guards

/**
 * 核心谓词：判断对变量 `v` 的字段访问 `deref` 是否被一个有效的空指针检查所保护。
 *
 * 使用 `ensuresEq(..., false)` 来判断一个 Guard 是否确保了变量不为 NULL。
 */
predicate isProtectedByNullCheck(FieldAccess deref, Variable v) {
  exists(GuardCondition nullCheck |
    // nullCheck.ensuresEq(v.getAnAccess(), 0, ..., false) 的含义是：
    // Guard `nullCheck` 确保了 `v` 的值不等于(false) 0 (NULL)，
    // 在 `deref` 所在的 BasicBlock 中。
    nullCheck.ensuresEq(v.getAnAccess(), 0, deref.getBasicBlock(), false)
  )
}

from
  Function cacheSetFlush,
  LocalVariable ca,
  FieldAccess deref
where
  cacheSetFlush.hasName("cache_set_flush") and
  cacheSetFlush.getFile().getRelativePath().matches("drivers/md/bcache/super.c") and

  ca.getFunction() = cacheSetFlush and
  ca.hasName("ca") and

  deref.getQualifier().(VariableAccess).getTarget() = ca and

  not isProtectedByNullCheck(deref, ca)
select deref, "对变量 '" + ca.getName() + "' 的解引用缺少空指针检查。"
