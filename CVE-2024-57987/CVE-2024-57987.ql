/**
 * @name CVE-2024-57987
 * @description Detects potential NULL pointer dereference in btrtl_setup_realtek()
 *  when accessing btrtl_dev->ic_info fields for unsupported chips not
 *  present in ic_id_table; guard hci_set_hw_info() with a NULL check.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/unchecked-null-dereference
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  null-dereference
 *  external/cwe/cwe-476
 * @patch-commit 3c15082f3567032d196e8760753373332508c2ca
 * @source-file drivers/bluetooth/btrtl.c
 * @affected-function btrtl_setup_realtek
 * @kernel-config N/A
 * @vulnerability-type null-pointer-dereference
 * @patch-diff |
 *  diff --git a/drivers/bluetooth/btrtl.c b/drivers/bluetooth/btrtl.c
 *  index 83025f457ca044…d3eba0d4a57d3b 100644
 *  --- a/drivers/bluetooth/btrtl.c
 *  +++ b/drivers/bluetooth/btrtl.c
 *  @@ -1351,12 +1351,14 @@ int btrtl_setup_realtek(struct hci_dev *hdev)
 *
 *    btrtl_set_quirks(hdev, btrtl_dev);
 *
 *  - hci_set_hw_info(hdev,
 *  + if (btrtl_dev->ic_info) {
 *  + hci_set_hw_info(hdev,
 *    "RTL lmp_subver=%u hci_rev=%u hci_ver=%u hci_bus=%u",
 *    btrtl_dev->ic_info->lmp_subver,
 *    btrtl_dev->ic_info->hci_rev,
 *    btrtl_dev->ic_info->hci_ver,
 *    btrtl_dev->ic_info->hci_bus);
 *  + }
 *
 *    btrtl_free(btrtl_dev);
 *    return ret;
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c15082f3567032d196e8760753373332508c2ca
 * @remediation Validate pointer members (e.e., btrtl_dev->ic_info) before dereferencing; guard
 *  hci_set_hw_info() and similar accesses with explicit NULL checks and handle
 *  unsupported devices gracefully (skip setup or return an appropriate error).
 */



import cpp

// 查找特定的函数调用模式
from
  FunctionCall fc, FunctionCall btrtl_set_quirks, Function btrtl_setup_realtek
where
  fc.getTarget().getName() = "hci_set_hw_info" and
  btrtl_set_quirks.getTarget().getName() = "btrtl_set_quirks" and
  btrtl_setup_realtek.getName() = "btrtl_setup_realtek" and
  fc.getEnclosingFunction() = btrtl_setup_realtek and
  btrtl_set_quirks.getEnclosingFunction() = btrtl_setup_realtek and
    // 检查缺少NULL检查
  not exists(IfStmt ifStmt |
    ifStmt.getCondition().toString().matches("%btrtl_dev->ic_info%") and
    ifStmt.getLocation().getStartLine() < fc.getLocation().getStartLine() and
    ifStmt.getLocation().getStartLine() > btrtl_set_quirks.getLocation().getStartLine()
  )
select
  fc,
  "Potential NULL pointer dereference: hci_set_hw_info called without checking 'btrtl_dev->ic_info' at line " +
  fc.getLocation().getStartLine() + ".",
  fc.getEnclosingFunction(),
  "Function: " + fc.getEnclosingFunction().getName()