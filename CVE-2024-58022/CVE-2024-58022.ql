/**
 * @name CVE-2024-58022
 * @description Detects incorrect error handling of devm_ioremap() results where IS_ERR() is used
 *  instead of a NULL check. devm_ioremap() returns NULL on failure, not error pointers,
 *  so using IS_ERR() misses failures and may propagate a NULL mapping leading to
 *  NULL pointer dereference or broken error paths. The fix checks for NULL and returns
 *  ERR_PTR(-ENOMEM) after logging.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/null-vs-is-err-check
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  null-dereference
 *  external/cwe/cwe-476
 *  external/cwe/cwe-252
 * @patch-commit ecbde88e544ff016fa08bbf2156dc431bb123e9b
 * @source-file drivers/mailbox/mailbox-th1520.c
 * @affected-function th1520_map_mmio
 * @kernel-config N/A
 * @vulnerability-type null-pointer-dereference
 * @patch-diff |
 *  diff --git a/drivers/mailbox/mailbox-th1520.c b/drivers/mailbox/mailbox-th1520.c
 *  index 4e84640ac3b876…e16e7c85ee3cd5 100644
 *  --- a/drivers/mailbox/mailbox-th1520.c
 *  +++ b/drivers/mailbox/mailbox-th1520.c
 *  @@ -387,8 +387,10 @@ static void __iomem *th1520_map_mmio(struct platform_device *pdev,
 *
 *    mapped = devm_ioremap(&pdev->dev, res->start + offset,
 *    resource_size(res) - offset);
 *  - if (IS_ERR(mapped))
 *  + if (!mapped) {
 *    dev_err(&pdev->dev, "Failed to map resource: %s\n", res_name);
 *  + return ERR_PTR(-ENOMEM);
 *  + }
 *
 *    return mapped;
 *    }
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecbde88e544ff016fa08bbf2156dc431bb123e9b
 * @remediation For APIs that return NULL on failure (e.g., devm_ioremap), check for NULL rather than
 *  using IS_ERR(). On failure, log appropriately and return an ERR_PTR(…) to keep
 *  error propagation consistent with callers expecting ERR_PTR-encoded failures.
 * @patch-description |
 *  mailbox: th1520: Fix a NULL vs IS_ERR() bug
 *  [ Upstream commit d0f98e14c010bcf27898b635a54c1994ac4110a8 ]
 *  
 *  The devm_ioremap() function doesn't return error pointers, it returns
 *  NULL.  Update the error checking to match.
 *  
 *  Fixes: 5d4d263e1c6b ("mailbox: Introduce support for T-head TH1520 Mailbox driver")
 */

import cpp

/*
 * 检测th1520_map_mmio函数中devm_ioremap()错误检查问题
 * 该查询用于识别错误使用IS_ERR()检查devm_ioremap()返回值的情况
 * devm_ioremap()返回NULL表示失败，而不是错误指针，应该使用NULL检查
 * This query identifies incorrect usage of IS_ERR() to check devm_ioremap() return value
 * devm_ioremap() returns NULL on failure, not error pointers
 */


from
  Function f, FunctionCall devm_ioremap, FunctionCall isErr, AssignExpr ae
where
  // 限制在th1520_map_mmio函数内
  f.getName() = "th1520_map_mmio" and
  devm_ioremap.getEnclosingFunction() = f and
  isErr.getEnclosingFunction() = f and
  // 查找devm_ioremap调用
  devm_ioremap.getTarget().getName() = "devm_ioremap" and
  // 查找IS_ERR调用
  isErr.getTarget().getName() = "IS_ERR" and
  // IS_ERR检查的是devm_ioremap的返回值
  ae.getEnclosingFunction() = f and
  ae.getRValue() = devm_ioremap and
  ae.getLValue().toString() = isErr.getArgument(0).toString()


select
  isErr, 
  "Potential NULL vs IS_ERR() bug: devm_ioremap() returns NULL on failure, not error pointers. Use NULL check instead of IS_ERR()."