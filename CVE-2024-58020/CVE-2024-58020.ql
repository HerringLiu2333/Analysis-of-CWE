/**
 * @name CVE-2024-58020
 * @description Detects uses of devm_kasprintf (and similar allocation/formatting helpers)
 *  without checking for a NULL return in mt_input_configured(), which can lead
 *  to NULL pointer dereference and system instability on allocation failure paths.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/unchecked-null-return
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  null-dereference
 *  external/cwe/cwe-476
 *  external/cwe/cwe-690
 *  external/cwe/cwe-252
 * @patch-commit aa879ef6d3acf96fa2c7122d0632061d4ea58d48
 * @source-file drivers/hid/hid-multitouch.c
 * @affected-function mt_input_configured
 * @kernel-config N/A
 * @vulnerability-type null-pointer-dereference
 * @patch-diff |
 *  diff --git a/drivers/hid/hid-multitouch.c b/drivers/hid/hid-multitouch.c
 *  index 369414c92fccbe…93b5c648ef82c9 100644
 *  --- a/drivers/hid/hid-multitouch.c
 *  +++ b/drivers/hid/hid-multitouch.c
 *  @@ -1673,9 +1673,12 @@ static int mt_input_configured(struct hid_device *hdev, struct hid_input *hi)
 *    break;
 *    }
 *
 *  - if (suffix)
 *  + if (suffix) {
 *    hi->input->name = devm_kasprintf(&hdev->dev, GFP_KERNEL,
 *    "%s %s", hdev->name, suffix);
 *  + if (!hi->input->name)
 *  + return -ENOMEM;
 *  + }
 *
 *    return 0;
 *  }
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa879ef6d3acf96fa2c7122d0632061d4ea58d48
 * @remediation Always check the return value of allocation/formatting helpers (e.g., devm_kasprintf, kasprintf, kmalloc)
 *   and handle failures early by returning -ENOMEM or unwinding resources as appropriate before dereferencing.
 */

import cpp

/*
 * 检测devm_kasprintf()使用中的NULL指针解引用漏洞
 * 该查询用于识别devm_kasprintf()返回值直接赋值给结构体字段而未进行NULL检查的情况
 * This query identifies cases where devm_kasprintf() return value is assigned
 * to a structure field without proper NULL check
 */



from
  AssignExpr assign, FunctionCall devm_kasprintf
where
  // 查找有问题的赋值：input->name = devm_kasprintf(...)
  assign.getRValue() = devm_kasprintf and
  devm_kasprintf.getTarget().getName() = "devm_kasprintf" and
  // 在赋值后没有找到NULL检查
  not exists(IfStmt ifstmt |
    ifstmt.getEnclosingBlock() = assign.getEnclosingBlock() and
    ifstmt.getCondition().getAPredecessor().toString() = assign.getLValue().toString() and
    ifstmt.getLocation().getStartLine() > assign.getLocation().getStartLine()
  )
select
  assign,
  "Potential NULL pointer dereference: devm_kasprintf() return value assigned to input->name without NULL check"