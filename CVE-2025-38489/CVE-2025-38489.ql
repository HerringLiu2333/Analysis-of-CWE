/**
 * @name S390 BPF JIT PLT目标指针竞态条件漏洞检测
 * @description 检测s390架构下BPF JIT编译器中PLT条目设置时可能导致竞态条件的NULL指针赋值
 * @kind problem
 * @problem.severity error
 * @security-severity 8.1
 * @precision high
 * @id cpp/s390-bpf-plt-race-condition
 * @tags security
 *       external/cwe/cwe-362
 *       external/cve/cve-2025-38489
 */

import cpp

/**
 * 表示bpf_plt结构体类型
 */
class BpfPltStruct extends Struct {
  BpfPltStruct() {
    this.getName() = "bpf_plt"
  }
}

/**
 * 表示PLT条目中的target字段
 */
class PltTargetField extends Field {
  PltTargetField() {
    this.getName() = "target" and
    this.getDeclaringType() instanceof BpfPltStruct
  }
}

/**
 * 表示bpf_jit_plt函数
 */
class BpfJitPltFunction extends Function {
  BpfJitPltFunction() {
    this.getName() = "bpf_jit_plt" and
    this.getFile().getBaseName() = "bpf_jit_comp.c"
  }
}

/**
 * 表示对PLT target字段的赋值操作
 */
class PltTargetAssignment extends AssignExpr {
  PltTargetAssignment() {
    exists(FieldAccess fa |
      fa = this.getLValue() and
      fa.getTarget() instanceof PltTargetField
    )
  }
  
  /**
   * 获取赋值的右值表达式
   */
  Expr getAssignedValue() {
    result = this.getRValue()
  }
}

/**
 * 检查表达式是否可能为NULL
 */
predicate maybeNull(Expr e) {
  // 直接的NULL字面量
  e instanceof NullValue
  or
  // 变量可能为NULL（简化的启发式检查）
  exists(Variable v |
    v.getAnAccess() = e and
    (
      // 函数参数，可能从外部传入NULL
      v instanceof Parameter
      or
      // 指针类型的变量
      v.getType() instanceof PointerType
    )
  )
}

/**
 * 检查是否存在NULL检查保护
 */
predicate hasNullCheck(PltTargetAssignment assignment, Expr checkedExpr) {
  exists(IfStmt ifStmt, Expr condition |
    // 赋值操作在if语句内部
    ifStmt.getThen().getAChild*() = assignment and
    condition = ifStmt.getCondition() and
    (
      // 直接的NULL检查: if (target != NULL)
      exists(NEExpr neq |
        neq = condition and
        neq.getAnOperand() = checkedExpr and
        neq.getAnOperand() instanceof NullValue
      )
      or
      // 简单的真值检查: if (target)
      condition = checkedExpr
      or
      // 逻辑非的NULL检查: if (!target) ... else
      exists(NotExpr notExpr |
        notExpr = condition and
        notExpr.getOperand() = checkedExpr and
        ifStmt.getElse().getAChild*() = assignment
      )
    )
  )
}

/**
 * 检查是否使用了三元运算符进行NULL安全处理
 */
predicate hasTernaryNullHandling(PltTargetAssignment assignment) {
  exists(ConditionalExpr ternary |
    ternary = assignment.getAssignedValue() and
    (
      // target ?: ret 形式
      exists(Expr condition, Expr elseExpr |
        condition = ternary.getCondition() and
        elseExpr = ternary.getElse() and
        // 条件是某个可能为NULL的表达式
        maybeNull(condition) and
        // else分支不是NULL
        not elseExpr instanceof NullValue
      )
      or
      // target != NULL ? target : ret 形式
      exists(NEExpr neq, Expr thenExpr, Expr elseExpr |
        neq = ternary.getCondition() and
        thenExpr = ternary.getThen() and
        elseExpr = ternary.getElse() and
        neq.getAnOperand() instanceof NullValue and
        not elseExpr instanceof NullValue
      )
    )
  )
}

from PltTargetAssignment assignment, Expr assignedValue
where
  // 赋值发生在bpf_jit_plt函数中
  assignment.getEnclosingFunction() instanceof BpfJitPltFunction and
  assignedValue = assignment.getAssignedValue() and
  // 被赋值的表达式可能为NULL
  maybeNull(assignedValue) and
  // 没有适当的NULL检查保护
  not hasNullCheck(assignment, assignedValue) and
  // 没有使用三元运算符进行NULL安全处理
  not hasTernaryNullHandling(assignment) and
  // 排除已经使用安全模式的直接赋值（如 target ?: ret）
  not exists(ConditionalExpr ternary |
    ternary = assignedValue and
    ternary.getCondition() = assignedValue
  )
select assignment,
  "在s390 BPF JIT中，PLT target字段的直接赋值可能导致竞态条件。当target参数为NULL时，" +
  "应使用安全的赋值方式（如 'target ?: ret'）以避免NULL指针跳转导致的内核崩溃。" +
  "这个问题可能在多CPU并发环境下，当一个CPU正在修补代码而另一个CPU尝试执行PLT跳转时发生。"