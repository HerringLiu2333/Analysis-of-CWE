/**
 * @name CVE-2025-38315
 * @description Detects improper handling of UEFI variable retrieval where the size of the returned
 *              data is not correctly validated against the expected buffer size. This can lead to
 *              the use of incorrect data, potentially causing system instability.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/improper-uefi-variable-size-check
 * @tags security
 *       correctness
 *       external/cwe/cwe-20
 *       external/cwe/cwe-129
 * @patch-commit 3aa1dc3c9060e335e82e9c182bf3d1db29220b1b
 * @source-file drivers/bluetooth/btintel.c
 * @affected-function btintel_uefi_get_dsbr
 * @kernel-config CONFIG_BT_INTEL
 * @vulnerability-type improper-input-validation
 * @patch-diff |
 *      @@ -2719,7 +2719,7 @@ static int btintel_uefi_get_dsbr(u32 *dsbr_var)
 *       	} __packed data;
 *       
 *       	efi_status_t status;
 *      -	unsigned long data_size = 0;
 *      +	unsigned long data_size = sizeof(data);
 *       	efi_guid_t guid = EFI_GUID(0xe65d8884, 0xd4af, 0x4b20, 0x8d, 0x03,
 *       				   0x77, 0x2e, 0xcc, 0x3d, 0xa5, 0x31);
 *       
 *      @@ -2730,15 +2730,9 @@ static int btintel_uefi_get_dsbr(u32 *dsbr_var)
 *       		return -EOPNOTSUPP;
 *       
 *       	status = efi.get_variable(BTINTEL_EFI_DSBR, &guid, NULL, &data_size,
 *      -				  NULL);
 *      -
 *      -	if (status != EFI_BUFFER_TOO_SMALL || !data_size)
 *      -		return -EIO;
 *      -
 *      -	status = efi.get_variable(BTINTEL_EFI_DSBR, &guid, NULL, &data_size,
 *       				  &data);
 *       
 *      -	if (status != EFI_SUCCESS)
 *      +	if (status != EFI_SUCCESS || data_size != sizeof(data))
 *       		return -ENXIO;
 *       
 *       	*dsbr_var = data.dsbr;
 * @references https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-38315
 * @remediation
 */

import cpp

from Function f
where f.getName() = "btintel_uefi_get_dsbr"
select f