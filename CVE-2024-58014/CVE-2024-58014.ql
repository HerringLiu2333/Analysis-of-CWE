/**
 * @name CVE-2024-58014
 * @description Detects missing bounds validation for gain index in wlc_phy_iqcal_gainparams_nphy(),
 *  which can lead to out-of-bounds access of tbl_iqcal_gainparams_nphy. Adds a WARN_ON
 *  check to ensure k != NPHY_IQCAL_NUMGAINS and returns early to prevent OOB reads.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/out-of-bounds-read-index
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  out-of-bounds-read
 *  external/cwe/cwe-125
 * @patch-commit d280a12e9b87819a8a209639d600b48a2d6d65dc
 * @source-file drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_n.c
 * @affected-function wlc_phy_iqcal_gainparams_nphy
 * @kernel-config N/A
 * @vulnerability-type out-of-bounds-read
 * @patch-diff |
 *  diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_n.c b/drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_n.c
 *  index 8580a275478918â€¦42e7bc67e9143e 100644
 *  --- a/drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_n.c
 *  +++ b/drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_n.c
 *  @@ -23427,6 +23427,9 @@ wlc_phy_iqcal_gainparams_nphy(struct brcms_phy *pi, u16 core_no,
 *    break;
 *  }
 *
 *  + if (WARN_ON(k == NPHY_IQCAL_NUMGAINS))
 *  + return;
 *  +
 *    params->txgm = tbl_iqcal_gainparams_nphy[band_idx][k][1];
 *    params->pga = tbl_iqcal_gainparams_nphy[band_idx][k][2];
 *    params->pad = tbl_iqcal_gainparams_nphy[band_idx][k][3];
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d280a12e9b87819a8a209639d600b48a2d6d65dc
 * @remediation Validate computed indices before table access. Specifically, ensure k is within
 *  [0, NPHY_IQCAL_NUMGAINS) and return early (optionally with WARN_ON) when out of
 *  range to prevent out-of-bounds reads of tbl_iqcal_gainparams_nphy.
 * @patch-description |
 *  wifi: brcmsmac: add gain range check to wlc_phy_iqcal_gainparams_nphy()
 *  [ Upstream commit 3f4a0948c3524ae50f166dbc6572a3296b014e62 ]
 *  
 *  In 'wlc_phy_iqcal_gainparams_nphy()', add gain range check to WARN()
 *  instead of possible out-of-bounds 'tbl_iqcal_gainparams_nphy' access.
 *  Compile tested only.
 *
 *  Found by Linux Verification Center (linuxtesting.org) with SVACE.
 */


import cpp

from ArrayExpr tbl_iqcal_gainparams_nphy, Variable k, ForStmt forstmt, IfStmt ifarray, BreakStmt bs, LTExpr lt
where
  forstmt.getEnclosingFunction().getName() = "wlc_phy_iqcal_gainparams_nphy" and
  forstmt.getUpdate().getASuccessor().toString() = k.toString() and
  ifarray = forstmt.getStmt().getASuccessor() and
  ifarray.getASuccessor() = tbl_iqcal_gainparams_nphy.getArrayBase() and
  ifarray.getThen() = bs and
  lt = forstmt.getCondition() and
  (lt.getLesserOperand().toString() = k.toString() or
  lt.getGreaterOperand().toString() = k.toString()) and
  not exists(IfStmt ifstmt |
    exists(EQExpr eq |
      (eq.getLeftOperand().toString() = lt.getLesserOperand().toString() or
      eq.getRightOperand().toString() = lt.getLesserOperand().toString() or
      eq.getLeftOperand().toString() = lt.getGreaterOperand().toString() or
      eq.getRightOperand().toString() = lt.getGreaterOperand().toString()) and
      eq.getLocation().getStartLine() = ifstmt.getLocation().getStartLine()
    ) and
    ifstmt.getLocation().getStartLine() > forstmt.getLocation().getStartLine()
  )
  
select ifarray, "Potential array out-of-bounds access: missing bounds check after search loop for index "