import cpp

// 定义全局变量
class GlobalCounter extends GlobalVariable {
  GlobalCounter() {
    // 匹配名为 adxl_component_count 的全局变量
    this.getName() = "adxl_component_count"
  }
}

// 定义清理函数
class CleanupFunction extends Function {
  CleanupFunction() {
    // 匹配名为 skx_adxl_put 的函数
    this.getName() = "skx_adxl_put"
  }
}

from CleanupFunction cleanup, GlobalCounter counter
where
  // 在清理函数中查找对计数器的赋值操作
  not exists(Assignment a |
    a.getEnclosingFunction() = cleanup and
    a.getLValue().(VariableAccess).getTarget() = counter and
    a.getRValue().getValue() = "0"
  )
select cleanup,
  "清理函数 '" + cleanup.getName() + "' 未重置全局计数器 '" + counter.getName() +
    "'，可能导致模块重载时计数错误"