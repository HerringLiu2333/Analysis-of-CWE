/**
 * @name 数组越界读取漏洞检测 - 循环中使用硬编码边界
 * @description 检测在for循环中使用硬编码常量作为数组访问边界，而不是使用ARRAY_SIZE等安全宏的情况
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/hardcoded-array-boundary-in-loop
 * @tags security
 *       correctness
 *       external/cwe/cwe-125
 */

import cpp

// 判断表达式是否是数组访问
predicate isArrayAccess(ArrayExpr arrayAccess, Variable array, Expr index) {
  arrayAccess.getArrayBase() = array.getAnAccess() and
  arrayAccess.getArrayOffset() = index
}

// 判断for循环是否使用硬编码常量作为边界
predicate hasHardcodedBoundary(ForStmt forLoop, int boundaryValue) {
  exists(RelationalOperation relOp, Literal boundaryLiteral |
    forLoop.getCondition() = relOp and
    relOp.getAnOperand() = boundaryLiteral and
    boundaryLiteral.getValue().toInt() = boundaryValue and
    boundaryValue > 0
  )
}

// 检查变量是否是数组类型
predicate isArrayVariable(Variable v) {
  v.getType() instanceof ArrayType
}

// 判断表达式是否使用了ARRAY_SIZE宏或类似的安全计算
predicate usesSafeArraySizeMacro(Expr expr) {
  exists(MacroInvocation macro |
    macro.getMacroName().matches("%ARRAY_SIZE%") and
    expr = macro.getExpr()
  )
  or
  exists(SizeofExprOperator sizeofExpr, DivExpr divExpr |
    divExpr.getLeftOperand() = sizeofExpr and
    expr = divExpr
  )
}

from ForStmt forLoop, ArrayExpr arrayAccess, Variable arrayVar, Variable loopVar, int hardcodedBound
where
  // 在for循环体内存在数组访问
  arrayAccess.getEnclosingStmt().getParent*() = forLoop.getStmt() and
  
  // 数组访问使用循环变量作为索引
  isArrayAccess(arrayAccess, arrayVar, loopVar.getAnAccess()) and
  
  // 确保被访问的是数组类型变量
  isArrayVariable(arrayVar) and
  
  // for循环使用硬编码边界
  hasHardcodedBoundary(forLoop, hardcodedBound) and
  
  // 循环变量在for循环的条件中被使用
  exists(VariableAccess va |
    va = loopVar.getAnAccess() and
    va.getParent*() = forLoop.getCondition()
  ) and
  
  // 排除已经使用安全宏的情况
  not exists(Expr child |
    child = forLoop.getCondition().getAChild*() and
    usesSafeArraySizeMacro(child)
  )

select forLoop, 
  "在循环中使用硬编码边界值 " + hardcodedBound + " 访问数组 '" + arrayVar.getName() + 
  "'，这可能导致数组越界读取。建议使用 ARRAY_SIZE(" + arrayVar.getName() + ") 替代硬编码常量。"