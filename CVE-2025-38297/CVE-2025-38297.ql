import cpp

/**
 * 匹配 em_compute_costs 函数
 */
class EmComputeCostsFunction extends Function {
  EmComputeCostsFunction() {
    this.hasName("em_compute_costs") and
    this.getFile().getBaseName() = "energy_model.c"
  }
}

/**
 * 匹配除法表达式中的 performance 字段访问
 */
class PerformanceDivExpr extends DivExpr {
  PerformanceDivExpr() {
    exists(FieldAccess fa |
      fa.getTarget().hasName("performance") and
      this.getRightOperand() = fa
    )
  }
}

from EmComputeCostsFunction func, PerformanceDivExpr div
where
  // 在目标函数内
  div.getEnclosingFunction() = func and
  // 确保这个除法操作不在设备类型检查的保护之下
  not exists(IfStmt ifStmt |
    ifStmt.getEnclosingFunction() = func and
    ifStmt.getCondition().(NotExpr).getOperand().toString().matches("%_is_cpu_device%") and
    dominates(ifStmt.getBasicBlock(), div.getBasicBlock())
  )
select div