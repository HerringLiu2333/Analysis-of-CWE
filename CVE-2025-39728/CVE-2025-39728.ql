/**
 * @name UBSAN数组边界检查导致的恐慌
 * @description 检测在数组访问之前未正确设置数组大小字段的代码模式
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/ubsan-array-bounds-panic
 * @tags security
 *       reliability
 *       external/cwe/cwe-125
 */

import cpp

from ArrayExpr arrayAccess, Assignment sizeAssign, FieldAccess arrayField, FieldAccess sizeField
where
  // 数组访问基于字段访问
  arrayAccess.getArrayBase() = arrayField and
  
  // 大小赋值给字段
  sizeAssign.getLValue() = sizeField and
  
  // 两个字段属于同一结构体类型
  arrayField.getTarget().getDeclaringType() = sizeField.getTarget().getDeclaringType() and
  
  // 大小字段名包含常见标识符
  (
    sizeField.getTarget().getName().matches("%num%") or
    sizeField.getTarget().getName().matches("%size%") or
    sizeField.getTarget().getName().matches("%count%") or
    sizeField.getTarget().getName().matches("%len%")
  ) and
  
  // 在同一函数中
  arrayAccess.getEnclosingFunction() = sizeAssign.getEnclosingFunction() and

  arrayAccess.getEnclosingFunction().getName() = "samsung_clk_init" and
  
  // 使用控制流分析：数组访问在大小字段赋值之前执行
  arrayAccess.getASuccessor*() = sizeAssign and
  
  // 排除在数组访问之前已经有其他地方设置了大小字段的情况
  not exists(Assignment earlierAssign |
    earlierAssign != sizeAssign and
    earlierAssign.getLValue().(FieldAccess).getTarget() = sizeField.getTarget() and
    earlierAssign.getASuccessor*() = arrayAccess and
    // 确保访问同一结构体实例
    earlierAssign.getLValue().(FieldAccess).getQualifier().toString() = 
    arrayField.getQualifier().toString()
  ) and
  
  // 确保访问同一结构体实例
  arrayField.getQualifier().toString() = sizeField.getQualifier().toString()

select arrayAccess, 
       "在设置大小字段之前访问数组，可能导致UBSAN边界检查触发恐慌。应该先设置 $@ 再访问数组。",
       sizeField, "大小字段"