/**
 * @name CVE-2025-38299
 * @description Detects the usage of `COMP_EMPTY()` for ASoC DAI link components, which can lead to a NULL pointer
 *              dereference. `COMP_EMPTY()` initializes the `codec_dai_name` to NULL. If the device tree
 *              does not assign a codec to these links, probe functions may attempt to use this NULL pointer
 *              in a string comparison, causing a kernel panic.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/null-pointer-in-asoc-dai-link
 * @tags security
 *       correctness
 *       kernel
 *       external/cwe/cwe-476
 * @patch-commit 7af317f7faaab09d5a78f24605057d11f5955115
 * @source-file sound/soc/mediatek/mt8195/mt8195-mt6359.c
 * @affected-function mtk_soundcard_common_probe
 * @kernel-config CONFIG_SND_SOC_MT8195_MT6359
 * @vulnerability-type null-pointer-dereference
 * @patch-diff |
 *     @@ -831,12 +831,12 @@ SND_SOC_DAILINK_DEFS(ETDM1_IN_BE,
 *      
 *      SND_SOC_DAILINK_DEFS(ETDM2_IN_BE,
 *     		     DAILINK_COMP_ARRAY(COMP_CPU("ETDM2_IN")),
 *     -		     DAILINK_COMP_ARRAY(COMP_EMPTY()),
 *     +		     DAILINK_COMP_ARRAY(COMP_DUMMY()),
 *     		     DAILINK_COMP_ARRAY(COMP_EMPTY()));
 *      
 *      SND_SOC_DAILINK_DEFS(ETDM1_OUT_BE,
 *     		     DAILINK_COMP_ARRAY(COMP_CPU("ETDM1_OUT")),
 *     -		     DAILINK_COMP_ARRAY(COMP_EMPTY()),
 *     +		     DAILINK_COMP_ARRAY(COMP_DUMMY()),
 *     		     DAILINK_COMP_ARRAY(COMP_EMPTY()));
 *      
 *      SND_SOC_DAILINK_DEFS(ETDM2_OUT_BE,
 * @references https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-38299
 * @remediation 
 */

import cpp
import semmle.code.cpp.dataflow.TaintTracking
import semmle.code.cpp.dataflow.DataFlow

// 查找COMP_EMPTY宏调用
class CompEmptyMacro extends MacroInvocation {
  CompEmptyMacro() {
    // 匹配COMP_EMPTY()宏调用
    this.getMacroName() = "COMP_EMPTY"
  }
}

// 查找SND_SOC_DAILINK_DEFS宏调用
class DailinkDefsMacro extends MacroInvocation {
  DailinkDefsMacro() {
    this.getMacroName() = "SND_SOC_DAILINK_DEFS"
  }
}

from CompEmptyMacro empty, DailinkDefsMacro dailink
where
  empty.getLocation().getFile().getBaseName() = "mt8195-mt6359.c" and
  dailink.getLocation().getFile().getBaseName() = "mt8195-mt6359.c" and
  // COMP_EMPTY在DAILINK_COMP_ARRAY中使用
  empty.getLocation().getFile() = dailink.getLocation().getFile() and
  // 确保COMP_EMPTY是在DAILINK_COMP_ARRAY内部使用的
  exists(MacroInvocation dailinkArray |
    dailinkArray.getMacroName() = "DAILINK_COMP_ARRAY" and
    dailinkArray.getLocation().getFile() = empty.getLocation().getFile() and
    dailinkArray.getLocation().getStartLine() = empty.getLocation().getStartLine()
  )
select empty