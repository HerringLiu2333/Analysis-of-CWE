/**
 * @name CVE-2024-57997
 * @description Detects incorrect dynamic allocation size for channel survey data in wcn36xx_probe()
 *  where devm_kmalloc was used with element count instead of count * sizeof(elem),
 *  leading to undersized allocation, KASAN reports, and potential use of uninitialized data.
 *  Fix switches to devm_kcalloc to allocate n_channels elements of struct wcn36xx_chan_survey
 *  and zero-initialize them.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/incorrect-allocation-size
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  memory-corruption
 *  uninitialized-memory
 *  external/cwe/cwe-131
 *  external/cwe/cwe-457
 * @patch-commit e95f9c408ff8311f75eeabc8acf34a66670d8815
 * @source-file drivers/net/wireless/ath/wcn36xx/main.c
 * @affected-function wcn36xx_probe
 * @kernel-config N/A
 * @vulnerability-type incorrect-allocation-size
 * @patch-diff |
 *  diff --git a/drivers/net/wireless/ath/wcn36xx/main.c b/drivers/net/wireless/ath/wcn36xx/main.c
 *  index 2bd1163177f08f…9bbbc86fd2d93d 100644
 *  --- a/drivers/net/wireless/ath/wcn36xx/main.c
 *  +++ b/drivers/net/wireless/ath/wcn36xx/main.c
 *  @@ -1586,7 +1586,10 @@ static int wcn36xx_probe(struct platform_device *pdev)
 *  }
 *
 *    n_channels = wcn_band_2ghz.n_channels + wcn_band_5ghz.n_channels;
 *  - wcn->chan_survey = devm_kmalloc(wcn->dev, n_channels, GFP_KERNEL);
 *  + wcn->chan_survey = devm_kcalloc(wcn->dev,
 *  + n_channels,
 *  + sizeof(struct wcn36xx_chan_survey),
 *  + GFP_KERNEL);
 *    if (!wcn->chan_survey) {
 *    ret = -ENOMEM;
 *    goto out_wq;
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e95f9c408ff8311f75eeabc8acf34a66670d8815
 * @remediation For arrays or per-channel/per-entry structures, allocate with kcalloc (or devm_kcalloc)
 *  using (count, sizeof(element)) to avoid size miscalculation and ensure zero-initialization.
 *  Validate allocation results and handle failures gracefully before use.
 */



import cpp

from FunctionCall devm_kmalloc, AssignExpr ae
where
  // 查找对kmalloc、kzalloc、devm_kmalloc等的调用
  devm_kmalloc.getTarget().getName() = "devm_kmalloc" and
  // 检查参数数量足够
  devm_kmalloc.getNumberOfArguments() = 3 and
  ae.getRValue() = devm_kmalloc and
  ae.getLValue().toString() = "chan_survey"
select devm_kmalloc, "Potential incorrect memory allocation size calculation - missing sizeof multiplication"