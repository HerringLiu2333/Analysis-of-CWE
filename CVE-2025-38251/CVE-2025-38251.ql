import cpp
import semmle.code.cpp.controlflow.ControlFlowGraph
import semmle.code.cpp.controlflow.Guards

// 定义一个谓词，用来判断一个 deref 是否满足原始查询的条件
predicate isFoundByOriginalQuery(PointerFieldAccess deref) {
  exists(Parameter skb, GuardCondition nullCheck |
    skb = deref.getQualifier().(VariableAccess).getTarget().(Parameter) and
    nullCheck.ensuresEq(skb.getAnAccess(), 0, deref.getBasicBlock(), false)
  )
}

from
  Function clip_push,
  Parameter skb,
  PointerFieldAccess deref
where
  // 1. 定义“全集”
  clip_push.hasName("clip_push") and
  clip_push.getFile().getRelativePath() = "net/atm/clip.c" and
  skb = clip_push.getParameter(1) and
  deref.getQualifier().(VariableAccess).getTarget() = skb and

  // 2. 使用谓词进行排除，逻辑更清晰
  not isFoundByOriginalQuery(deref)

select deref, skb