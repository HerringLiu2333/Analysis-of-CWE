/**
 * @name 检测PCMCIA驱动结构体中过时的name字段初始化导致的空指针解引用
 * @description 检测pcmcia_driver结构体使用过时的.drv.name初始化方式而不是直接的.name字段，
 *              这可能导致.name字段为NULL，在驱动注册时引发空指针解引用。
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/pcmcia-driver-null-name
 * @tags security
 *       reliability
 *       null-pointer-dereference
 *       driver
 *       pcmcia
 */

import cpp

/**
 * 表示pcmcia_driver结构体类型
 */
class PcmciaDriverStruct extends Struct {
  PcmciaDriverStruct() {
    this.getName() = "pcmcia_driver"
  }
}

/**
 * 表示pcmcia_driver结构体的初始化表达式
 */
class PcmciaDriverInit extends ClassAggregateLiteral {
  PcmciaDriverInit() {
    this.getType().stripType() instanceof PcmciaDriverStruct
  }

  /**
   * 检查是否存在直接的name字段初始化
   */
  predicate hasDirectNameInit() {
    exists(FieldAccess fa |
      fa = this.getAFieldExpr(_) and
      fa.getTarget().getName() = "name"
    )
  }

  /**
   * 检查是否存在过时的.drv.name初始化方式
   */
  predicate hasDeprecatedDrvNameInit() {
    exists(ClassAggregateLiteral drvInit, FieldAccess nameAccess |
      drvInit = this.getAFieldExpr(_) and
      drvInit.getType().stripType().(Struct).getName() = "device_driver" and
      nameAccess = drvInit.getAFieldExpr(_) and
      nameAccess.getTarget().getName() = "name"
    )
  }

  /**
   * 获取包含此初始化的变量声明
   */
  Variable getInitializedVariable() {
    exists(Initializer init |
      init.getExpr() = this and
      result = init.getDeclaration()
    )
  }
}

/**
 * 检查pcmcia_register_driver函数调用
 */
class PcmciaRegisterDriverCall extends FunctionCall {
  PcmciaRegisterDriverCall() {
    this.getTarget().getName() = "pcmcia_register_driver"
  }
  
  /**
   * 获取传递给注册函数的驱动结构体参数
   */
  Expr getDriverArg() {
    result = this.getArgument(0)
  }
}

from PcmciaDriverInit driverInit, Variable driverVar, PcmciaRegisterDriverCall registerCall
where
  // 驱动初始化使用了过时的.drv.name方式
  driverInit.hasDeprecatedDrvNameInit() and
  // 但没有直接的.name字段初始化
  not driverInit.hasDirectNameInit() and
  // 获取被初始化的变量
  driverVar = driverInit.getInitializedVariable() and
  // 该变量被传递给pcmcia_register_driver函数
  exists(VariableAccess va |
    va = registerCall.getDriverArg() and
    va.getTarget() = driverVar
  )
select driverInit, 
       "PCMCIA驱动 '$@' 使用过时的.drv.name初始化方式，缺少直接的.name字段初始化，" +
       "可能导致在调用 '$@' 时发生空指针解引用。",
       driverVar, driverVar.getName(),
       registerCall, "pcmcia_register_driver"