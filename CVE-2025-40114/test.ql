import cpp

predicate isArraySizeCheck(Expr expr, Variable arrayVar) {
  // ARRAY_SIZE宏展开后的形式: sizeof(array)/sizeof(array[0])
  exists(DivExpr divExpr, SizeofExprOperator sizeofArray, SizeofExprOperator sizeofElement |
    expr = divExpr and
    sizeofArray = divExpr.getLeftOperand() and
    sizeofElement = divExpr.getRightOperand() and
    // sizeof(array)
    sizeofArray.getExprOperand().(VariableAccess).getTarget() = arrayVar and
    // sizeof(array[0]) 或 sizeof(*array)
    (
      sizeofElement.getExprOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget() = arrayVar
      or
      sizeofElement.getExprOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget() = arrayVar
    )
  )
}


from IfStmt ifStmt, VariableAccess arrayVar
where arrayVar.toString() = "veml6075_it_ms" and
      arrayVar.getFile().getBaseName() = "veml6075.c" and
      ifStmt.getFile().getBaseName() = "veml6075.c" and
      isArraySizeCheck(ifStmt.getCondition().(GEExpr).getRightOperand().(AddExpr).getLeftOperand(), arrayVar.getTarget())
select arrayVar, ifStmt