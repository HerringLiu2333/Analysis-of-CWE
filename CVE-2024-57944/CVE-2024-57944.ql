/**
 * @name CVE-2024-57944
 * @description Detects uses of devm_kasprintf (and similar allocation/formatting helpers)
 *  without checking for a NULL return, which can lead to NULL pointer
 *  dereference and system instability on allocation failure paths.
 * @kind problem
 * @problem.severity error
 * @precision high
 * @id cpp/unchecked-null-return
 * @tags 
 *  security
 *  correctness
 *  reliability
 *  null-dereference
 *  external/cwe/cwe-476
 *  external/cwe/cwe-690
 *  external/cwe/cwe-252
 * @patch-commit bcb394bb28e55312cace75362b8e489eb0e02a30
 * @source-file drivers/iio/adc/ti-ads1298.c
 * @affected-function ads1298_init
 * @kernel-config N/A
 * @vulnerability-type null-pointer-dereference
 * @patch-diff |
 *  diff --git a/drivers/iio/adc/ti-ads1298.c b/drivers/iio/adc/ti-ads1298.c
 *  index 36d43495f603a7…03f762415fa5c3 100644
 *  --- a/drivers/iio/adc/ti-ads1298.c
 *  +++ b/drivers/iio/adc/ti-ads1298.c
 *  @@ -613,6 +613,8 @@ static int ads1298_init(struct iio_dev indio_dev)
 *  }
 *    indio_dev->name = devm_kasprintf(dev, GFP_KERNEL, "ads129%u%s",
 *    indio_dev->num_channels, suffix);
 *  + if (!indio_dev->name)
 *  +   return -ENOMEM;
 *  
 *    /* Enable internal test signal, double amplitude, double frequency &#47;
 *    ret = regmap_write(priv->regmap, ADS1298_REG_CONFIG2,
 * @references https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcb394bb28e55312cace75362b8e489eb0e02a30
 * @remediation Always check the return value of allocation/formatting helpers (e.g., devm_kasprintf, kasprintf, kmalloc) and handle failures early by returning -ENOMEM or unwinding resources as appropriate.
 *  Avoid dereferencing potentially NULL pointers; gate subsequent uses behind a successful non-NULL check.
 */

import cpp

/*
 * 检测devm_kasprintf()使用中的NULL指针解引用漏洞
 * 该查询用于识别devm_kasprintf()返回值直接赋值给结构体字段而未进行NULL检查的情况
 * This query identifies cases where devm_kasprintf() return value is assigned
 * to a structure field without proper NULL check
 */



from
  AssignExpr assign, FunctionCall devm_kasprintf
where
  // 查找有问题的赋值：input->name = devm_kasprintf(...)
  assign.getRValue() = devm_kasprintf and
  devm_kasprintf.getTarget().getName() = "devm_kasprintf" and
  // 在赋值后没有找到NULL检查
  not exists(IfStmt ifstmt |
    ifstmt.getEnclosingBlock() = assign.getEnclosingBlock() and
    ifstmt.getCondition().getAPredecessor().toString() = assign.getLValue().toString() and
    ifstmt.getLocation().getStartLine() > assign.getLocation().getStartLine()
  )
select
  assign,
  "Potential NULL pointer dereference: devm_kasprintf() return value assigned to indio_dev->name without NULL check"